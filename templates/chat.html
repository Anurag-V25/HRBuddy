<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HR Buddy • Chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#0056d2;--primary-2:#1a73e8;--bg:#f8f9fa;--white:#fff;
      --text:#202124;--muted:#5f6368;--border:#e8eaed;--bot:#f1f3f4;--user:#0056d2;
      --shadow:0 8px 32px rgba(0,0,0,.12)
    }
    *{box-sizing:border-box}html,body{height:100%}
    
    /* Background Theme */
    body{
      font-family:'Poppins', sans-serif;
      overflow:hidden;
      height:100vh;
      background: linear-gradient(135deg, #0a4d54 0%, #065a63 50%, #0a4d54 100%);
      margin:0;
      position:relative;
    }

    /* Theme Background Elements */
    .theme-background {
      position: fixed; 
      width: 100vw; 
      height: 100vh; 
      z-index: -1;
      top: 0; left: 0;
      background: linear-gradient(135deg, #0a4d54 0%, #065a63 50%, #0a4d54 100%);
      overflow: hidden;
    }

    .center-logo {
      position: absolute;
      top: 35%; 
      left: 50%; 
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 1;
    }

    .logo-text {
      font-size: 3.5rem;
      letter-spacing: 4px;
      color: #ffffff;
      font-family: 'Poppins', sans-serif;
      font-weight: 300;
      text-shadow: 
        0 0 10px rgba(255,255,255,0.8),
        0 0 20px rgba(77,208,225,0.6),
        0 0 30px rgba(77,208,225,0.4);
      animation: glow-pulse 3s ease-in-out infinite alternate;
    }

    .main-text {
      font-size: 4.2rem;
      font-weight: bold;
      color: #ffffff;
      margin-top: 1.5rem;
      font-family: 'Poppins', sans-serif;
      text-shadow: 
        0 0 15px rgba(255,255,255,0.9),
        0 0 30px rgba(77,208,225,0.7),
        0 0 45px rgba(77,208,225,0.5);
      animation: glow-pulse 3s ease-in-out infinite alternate;
      animation-delay: 1s;
    }

    @keyframes glow-pulse {
      0% {
        text-shadow: 
          0 0 10px rgba(255,255,255,0.8),
          0 0 20px rgba(77,208,225,0.6),
          0 0 30px rgba(77,208,225,0.4);
      }
      100% {
        text-shadow: 
          0 0 20px rgba(255,255,255,1),
          0 0 35px rgba(77,208,225,0.8),
          0 0 50px rgba(77,208,225,0.6);
      }
    }

    /* Technology-themed animations */
    .tech-elements {
      position: absolute;
      width: 100%; 
      height: 100%;
      z-index: 0;
    }

    /* Binary rain effect */
    .binary-rain {
      position: absolute;
      width: 2px;
      height: 100px;
      background: linear-gradient(to bottom, transparent, rgba(77,208,225,0.6), transparent);
      animation: binary-fall 8s infinite linear;
    }

    .binary-rain:nth-child(1) { left: 15%; animation-delay: 0s; }
    .binary-rain:nth-child(2) { left: 35%; animation-delay: 2s; }
    .binary-rain:nth-child(3) { left: 55%; animation-delay: 4s; }
    .binary-rain:nth-child(4) { left: 75%; animation-delay: 6s; }
    .binary-rain:nth-child(5) { left: 85%; animation-delay: 1s; }

    @keyframes binary-fall {
      0% { transform: translateY(-100px); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(calc(100vh + 100px)); opacity: 0; }
    }

    /* Circuit lines */
    .circuit-line {
      position: absolute;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(77,208,225,0.5), transparent);
      animation: circuit-pulse 6s infinite ease-in-out;
      box-shadow: 0 0 5px rgba(77,208,225,0.3);
    }

    .circuit-line.horizontal {
      width: 200px;
      left: 20%;
      top: 25%;
    }

    .circuit-line.horizontal:nth-child(2) {
      width: 150px;
      left: 60%;
      top: 70%;
      animation-delay: 3s;
    }

    .circuit-line.vertical {
      width: 1px;
      height: 150px;
      left: 25%;
      top: 40%;
      animation-delay: 2s;
    }

    @keyframes circuit-pulse {
      0%, 100% { opacity: 0.5; transform: scaleX(1); }
      50% { opacity: 1; transform: scaleX(1.1); }
    }

    /* Data particles */
    .data-particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: rgba(77,208,225,0.8);
      border-radius: 50%;
      animation: particle-float 12s infinite ease-in-out;
      box-shadow: 0 0 10px rgba(77,208,225,0.5);
    }

    .data-particle:nth-child(1) { left: 30%; top: 20%; animation-delay: 0s; }
    .data-particle:nth-child(2) { left: 70%; top: 40%; animation-delay: 4s; }
    .data-particle:nth-child(3) { left: 50%; top: 75%; animation-delay: 8s; }

    @keyframes particle-float {
      0%, 100% { transform: translateY(0) scale(1); opacity: 0.8; }
      25% { transform: translateY(-30px) scale(1.3); opacity: 1; }
      50% { transform: translateY(-60px) scale(0.9); opacity: 0.9; }
      75% { transform: translateY(-30px) scale(1.2); opacity: 1; }
    }

    /* Enhanced bubbles with tech glow */
    .bubbles {
      position: absolute;
      width: 100%; 
      height: 100%;
      z-index: 0;
    }

    .bubble {
      position: absolute;
      bottom: -100px;
      background: rgba(77,208,225,0.1);
      border-radius: 50%;
      opacity: 0.6;
      animation: bubble-anim 16s infinite ease-in;
      box-shadow: 0 0 15px rgba(77,208,225,0.3);
      border: 1px solid rgba(77,208,225,0.2);
    }

    .bubble:nth-child(1) { left: 20%; width: 36px; height: 36px; animation-delay: 0s;}
    .bubble:nth-child(2) { left: 60%; width: 22px; height: 22px; animation-delay: 5s;}
    .bubble:nth-child(3) { left: 80%; width: 48px; height: 48px; animation-delay: 8s;}
    .bubble:nth-child(4) { left: 35%; width: 26px; height: 26px; animation-delay: 2s;}
    .bubble:nth-child(5) { left: 70%; width: 32px; height: 32px; animation-delay: 12s;}
    .bubble:nth-child(6) { left: 15%; width: 18px; height: 18px; animation-delay: 7s;}

    @keyframes bubble-anim {
      0% { transform: translateY(0) scale(1); opacity: 0.6;}
      50% { opacity: 0.9;}
      100% { transform: translateY(-800px) scale(1.4); opacity: 0;}
    }

    /* Launcher */
    .launcher{
      position:fixed;
      right:40px;
      bottom:60px;
      width:35px;
      height:35px;
      border:0;
      background:linear-gradient(135deg, #0056d2, #1a73e8);
      border-radius:50%;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all .3s ease;
      z-index: 1000;
      box-shadow: 0 8px 25px rgba(66, 133, 244, 0.3);
    }
    .launcher img{
      width:80px;
      height:100px;
      object-fit:contain;
      border-radius:0%;
    }
    .launcher:hover{
      transform:scale(1.1);
      box-shadow: 0 12px 35px rgba(66, 133, 244, 0.4);
    }
    
    /* Widget - Chat Container */
    .widget{
      position:fixed;
      right:20px;
      bottom:20px;
      width:420px;
      height:606px;
      background:var(--white);
      border-radius:20px;
      box-shadow:0 25px 80px rgba(0,0,0,.15);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      z-index: 999;
      border: 1px solid rgba(66, 133, 244, 0.1);
      backdrop-filter: blur(10px);
    }
    .hidden{display:none!important}
    
    @media (max-width:480px){
      .widget{
        right:0;
        bottom:0;
        width:100vw;
        height:100vh;
        border-radius:0;
        border:none;
      }
    }
    
    /* Header */
    .header{
      background:linear-gradient(135deg,var(--primary) 0%,var(--primary-2) 100%);
      color:#fff;
      padding:6px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .h-left{display:flex;gap:15px;align-items:center}
    .avatar{
      height:45px;
      overflow: hidden;
    }
    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .h-meta{line-height:1.4}
    .h-title{font-weight:600;font-size:17px;margin-bottom:2px;}
    .h-sub{font-size:13px;opacity:.9;}
    .h-actions{display:flex;gap:8px}
    .icon-btn{
      width:36px;
      height:36px;
      border-radius:50%;
      border:0;
      background:rgba(255,255,255,.15);
      color:#fff;
      cursor:pointer;
      font-size:16px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .icon-btn:hover{background:rgba(255,255,255,.25)}
    .bar{height:3px;background:rgba(255,255,255,.2)}
    .bar > div{height:100%;background:#fff;width:0%;transition: width 0.3s ease;}
    
    /* Chat Body - IMPROVED */
    .body{
      flex:1;
      background: #f8f9fa;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 0;
      display: flex;
      flex-direction: column;
    }
    .body::-webkit-scrollbar{width:6px}
    .body::-webkit-scrollbar-thumb{background:#ddd;border-radius:10px}
    .body::-webkit-scrollbar-track{background:transparent}
    
    /* Message Container - COMPLETELY REDESIGNED */
    .msg{
      padding: 12px 16px;
      margin: 0;
      display: flex;
      flex-direction: column;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .msg.bot {
      align-items: flex-start;
    }
    
    .msg.user {
      align-items: flex-end;
    }
    
    /* Message Row */
    .row{
      display:flex;
      gap:12px;
      align-items:flex-end;
      max-width:85%;
      position: relative;
    }
    
    .bot .row{
      flex-direction: row;
    }
    
    .user .row{
      flex-direction: row-reverse;
    }
    
    /* Avatar Styling */
    .ava-s{
      width:36px;
      height:36px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
      overflow: hidden;
      border: 0px solid #e8eaed;
      background: #fff;
    }
    
    .ava-s img {
      width: 80%;
      height: 90%;
    }
    
    /* Message Bubbles - REDESIGNED */
    .bub{
      padding: 14px 19px;
      border-radius: 11px;
      font-size: 13px;
      line-height: 1.4;
      font-family: 'Poppins', sans-serif;
      font-weight: 400;
      max-width: 100%;
      position: relative;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      word-break: break-word;
    white-space: pre-line;
    overflow-wrap: anywhere;
    overflow: hidden;
    }
    
    .bot .bub{
      background: #ffffff;
      color: var(--text);
      border: 1px solid #e8eaed;
      border-bottom-left-radius: 20px;
      margin-left: -7px;
    }
    
    .user .bub{
      background: var(--primary);
      color: #fff;
      border-bottom-right-radius: 6px;
      margin-right: 0;
    }

    /* Markdown Content in Bubbles */
    .bub h1, .bub h2, .bub h3, .bub h4, .bub h5, .bub h6 {
      margin: 8px 0 6px 0;
      color: inherit;
      font-weight: 600;
    }
    
    .bub p {
      margin: -10px 0;
      line-height: 1.5;
    }
    
    .bub ul, .bub ol {
      margin: -10px 0;
      padding-left: 20px;
    }
    
    .bub li {
      margin: -8px 0;
    }
    
    .bub code {
      background: rgba(0,0,0,0.08);
      padding: 2px 4px;
      border-radius: 4px;
      font-size: 13px;
    }
    
    .bub pre {
      background: #f5f5f5;
      padding: 12px;
      border-radius: 8px;
      margin: 8px 0;
      overflow-x: auto;
    }
    
    .bub blockquote {
      border-left: 3px solid var(--primary);
      padding-left: 12px;
      margin: 8px 0;
      font-style: italic;
      opacity: 0.9;
    }
    
    .bub a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
    }
    
    .bub a:hover {
      text-decoration: underline;
    }
    
    .user .bub code {
      background: rgba(255,255,255,0.2);
    }
    
    .user .bub pre {
      background: rgba(255,255,255,0.1);
    }
    
    /* Timestamp */
    .ts{
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
      opacity: 0.7;
      font-weight: 400;
    }
    
    .bot .ts {
      text-align: left;
      margin-left: 48px;
    }
    
    .user .ts {
      text-align: right;
      margin-right: 48px;
    }
    
    /* Action Chips - IMPROVED */
    .chips{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
      margin-left: 48px;
    }
    
    .user .chips {
      margin-left: 0;
      margin-right: 48px;
      justify-content: flex-end;
    }
    
    .chip{
      padding: 8px 14px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Poppins', sans-serif;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .chip:hover{
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .chip:active{
      transform: translateY(0);
    }
    
    /* Typing Indicator - IMPROVED */
    .typing{
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      color: var(--muted);
      font-size: 14px;
      font-weight: 500;
    }
    .dots{display:flex;gap:4px;align-items:center;}
    .dot{
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--primary);
      animation: bounce 1.4s infinite ease-in-out;
    }
    .dot:nth-child(1){animation-delay: -0.32s;}
    .dot:nth-child(2){animation-delay: -0.16s;}
    .dot:nth-child(3){animation-delay: 0s;}
    
    @keyframes bounce {
      0%, 80%, 100% { 
        transform: scale(0.8);
        opacity: 0.5;
      }
      40% { 
        transform: scale(1);
        opacity: 1;
      }
    }
    
    /* Footer - INPUT AREA */
    .foot{
      background: #fff;
      border-top: 1px solid var(--border);
      padding: 4px 4px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    }
    
    
    .att{
      display: flex;
      align-items: center;
      gap: 8px;
      background: #e3f2fd;
      border: 1px solid #bbdefb;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      color: var(--primary-2);
    }
    .att button{
      border: 0;
      background: transparent;
      color: #e53935;
      cursor: pointer;
      font-size: 14px;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .in{
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }
    
    textarea{
      flex:1;resize:none;min-height:40px;max-height:100px;
      border:1px solid #ccc;border-radius:20px;padding:0px 14px;
      font-family:Poppins;font-size:12px;outline:none;transition:0.2s;
    }
    textarea:focus{
      outline: none;
      border-color: var(--primary);
      background: #fff;
      box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
    }
    textarea::placeholder{
      color: #999;
      font-weight: 400;
    }
    
    .btn{
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: 2px solid var(--border);
      background: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }
    .btn:hover{
      border-color: var(--primary);
      color: var(--primary);
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .send{
      background: var(--primary);
      border-color: var(--primary);
      color: #fff;
    }
    .send:hover{
      background: var(--primary-2);
      border-color: var(--primary-2);
      transform: scale(1.05);
    }
    .send:disabled{
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    input[type=file]{display:none}
    .link{color:var(--primary-2);text-decoration:none}
    
    /* Welcome Animation */
    .welcome-animation {
      animation: welcomeFade 0.5s ease-in;
    }
    
    @keyframes welcomeFade {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>

<!-- Theme Background -->
<div class="theme-background">
  <div class="center-logo">
    <div class="logo-text">Hoonartek</div>
    <div class="main-text">Realize AI</div>
  </div>
  
  <!-- Technology Elements -->
  <div class="tech-elements">
    <!-- Binary rain -->
    <div class="binary-rain"></div>
    <div class="binary-rain"></div>
    <div class="binary-rain"></div>
    <div class="binary-rain"></div>
    <div class="binary-rain"></div>
    
    <!-- Circuit lines -->
    <div class="circuit-line horizontal"></div>
    <div class="circuit-line horizontal"></div>
    <div class="circuit-line vertical"></div>
    
    <!-- Data particles -->
    <div class="data-particle"></div>
    <div class="data-particle"></div>
    <div class="data-particle"></div>
  </div>
  
  <div class="bubbles">
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
  </div>
</div>

<button class="launcher" id="launch">
  <img src="https://marketplace.canva.com/_o3Sg/MAGaMB_o3Sg/1/tl/canva-3d-robot-character-reading-a-book-illustration-MAGaMB_o3Sg.png" alt="Bot" />
</button>

<div class="widget hidden" id="widget">
  <div class="header">
    <div class="h-left">
      <div class="avatar">
        <img src="https://marketplace.canva.com/_o3Sg/MAGaMB_o3Sg/1/tl/canva-3d-robot-character-reading-a-book-illustration-MAGaMB_o3Sg.png" alt="HR Buddy" />
      </div>
      <div class="h-meta">
        <div class="h-title">HR Buddy</div>
      </div>
    </div>
    <div class="h-actions">
      <button class="icon-btn" id="refresh" title="Refresh">↻</button>
      <button class="icon-btn" id="min" title="Minimize">−</button>
      <button class="icon-btn" id="close" title="Close">×</button>
    </div>
  </div>
  <div class="bar"><div id="bar"></div></div>

  <div class="body" id="feed"></div>

  <div class="foot">
    <div class="in">
      <textarea id="box" placeholder="Type your message here..."></textarea>
      <button class="btn send" id="send">➤</button>
    </div>
  </div>
</div>

<script>
const API_CHAT   = "/api/chat";
const API_UPLOAD = "/api/upload";
const TOKEN      = localStorage.getItem("hrbuddy_token");

let docToTagIndex = null;
const launch  = qs("#launch");
const widget  = qs("#widget");
const feed    = qs("#feed");
const bar     = qs("#bar");
const box     = qs("#box");
const sendBtn = qs("#send");

function qs(s, p=document){ return p.querySelector(s); }
function elem(tag, cls, html){ 
  const e=document.createElement(tag); 
  if(cls)e.className=cls; 
  if(html!==undefined)e.innerHTML=html; 
  return e; 
}
function nowTs(){
  return new Date().toLocaleString('en-US',{weekday:'short',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
}
function scrollEnd(){ setTimeout(()=>{ feed.scrollTop = feed.scrollHeight; }, 100); }
function setProgress(p){ bar.style.width = Math.max(0, Math.min(100, p)) + "%"; }

function addBot(html, meta){
  const wrap = elem('div','msg bot');
  const row = elem('div','row');
  const ava = elem('div','ava-s');
  ava.innerHTML = `<img src="https://marketplace.canva.com/_o3Sg/MAGaMB_o3Sg/1/tl/canva-3d-robot-character-reading-a-book-illustration-MAGaMB_o3Sg.png" alt="Bot" />`;
  const bub = elem('div','bub');
  
  // Process markdown content
  if(window.marked) {
    bub.innerHTML = marked.parse(html);
  } else {
    // Fallback - simple text processing
    bub.innerHTML = html.replace(/\n/g, '<br>');
  }
  
  row.append(ava, bub); 
  wrap.append(row);
  
  // Add timestamp
  const timestamp = elem('div', 'ts', nowTs());
  wrap.append(timestamp);

  // Add feedback buttons if available
  if(meta && meta.feedback_buttons && Array.isArray(meta.feedback_buttons)){
    const fbRow = elem('div','chips');
    meta.feedback_buttons.forEach((label, idx) => {
      const btn = elem('button','chip',label);
      btn.onclick = async () => {
        typing(true);
        const r = await fetch(API_CHAT,{
          method:'POST',
          headers:{'Content-Type':'application/json','Authorization':'Bearer '+TOKEN},
          body:JSON.stringify({feedback: idx === 0 ? 'thumbs_up' : 'thumbs_down'})
        });
        const j = await r.json(); 
        typing(false);
        if(j.reply) addBot(j.reply, j.meta || {});
        btn.disabled = true;
      };
      fbRow.appendChild(btn);
    });
    wrap.appendChild(fbRow);
  }

  feed.append(wrap); 
  scrollEnd();
  return {bub, wrap};
}

function addUser(text){
  const wrap = elem('div','msg user');
  const row = elem('div','row');
  // Remove or comment out the avatar for user
  // const ava = elem('div','ava-s');
  // const userName = 'User';
  // ava.textContent = userName;

  const bub = elem('div','bub',escapeHtml(text));
  // Only append the bubble (not the avatar)
  row.append(bub); 
  wrap.append(row);

  // Add timestamp
  const timestamp = elem('div', 'ts', nowTs());
  wrap.append(timestamp);

  feed.append(wrap); 
  scrollEnd();
}

function typing(show=true){
  const id = 'typing';
  const exist = qs('#'+id, feed);
  if(show && !exist){
    const w = elem('div','msg bot'); 
    w.id = id;
    const r = elem('div','row');
    const ava = elem('div','ava-s');
    ava.innerHTML = `<img src="https://marketplace.canva.com/_o3Sg/MAGaMB_o3Sg/1/tl/canva-3d-robot-character-reading-a-book-illustration-MAGaMB_o3Sg.png" alt="Bot" />`;
    const bub = elem('div','bub');
    const t = elem('div','typing','HR Buddy is typing');
    const dots = elem('div','dots'); 
    dots.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
    t.append(dots); 
    bub.append(t); 
    r.append(ava, bub); 
    w.append(r); 
    feed.append(w); 
    scrollEnd();
  }
  if(!show && exist) exist.remove();
}

function chips(options, onClick){
  const c = elem('div','chips');
  options.forEach(o=>{
    const chip = elem('button','chip',o.label);
    chip.addEventListener('click', ()=>onClick(o.value, chip));
    c.append(chip);
  });
  return c;
}

function refreshAttach(){
}

// Event Listeners
launch.onclick = ()=>{ 
  widget.classList.remove('hidden'); 
  launch.classList.add('hidden'); 
  start(); 
};

qs("#min").onclick = ()=>{ 
  widget.classList.add('hidden'); 
  launch.classList.remove('hidden'); 
};

qs("#close").onclick = ()=>{ 
  widget.classList.add('hidden'); 
  launch.classList.remove('hidden'); 
};

qs("#refresh").onclick = ()=>{ 
  feed.innerHTML=''; 
  setProgress(0); 
  start(); 
};

sendBtn.onclick = sendMessage;

box.addEventListener('keydown',(e)=>{ 
  if(e.key==='Enter' && !e.shiftKey){ 
    e.preventDefault(); 
    sendMessage(); 
  }
});



async function start(){
  if(!TOKEN){
    addBot("⚠️ You are not logged in. Please sign in again to continue.");
    return;
  }
  
  try{
    typing(true);
    const isOnboarding = location.search.includes('mode=onboarding');
    const r = await fetch(API_CHAT,{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+TOKEN},
      body:JSON.stringify({message:'__init__', mode: isOnboarding ? 'onboarding' : ''})
    });
    typing(false);
    const j = await r.json();
    setProgress(15);
    
    if(j.redirect) {
      window.location.href = j.redirect;
      return;
    }
    
    if(j.reply) {
      const {bub, wrap} = addBot(j.reply, j.meta || {});
      
      if(j.actions && Array.isArray(j.actions) && j.actions.length > 0) {
        const btnRow = elem('div','chips');
        j.actions.forEach(a => {
          const btn = elem('button','chip',a.label);
          btn.onclick = () => handleActionClick(a);
          btnRow.appendChild(btn);
        });
        wrap.appendChild(btnRow);
      }
    }
    setProgress(100);
  }catch(e){
    typing(false);
    addBot("⚠️ Unable to start the conversation. Please refresh and try again.");
  }
}

function handleActionClick(action) {
  box.value = '';
  addUser(action.label);
  typing(true);
  
  const isOnboarding = location.search.includes('mode=onboarding');
  fetch(API_CHAT,{
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+TOKEN},
    body:JSON.stringify({message:action.send, mode: isOnboarding ? 'onboarding' : ''})
  })
  .then(r=>r.json())
  .then(j=>{
    typing(false);
    if(j.reply) {
      const {bub, wrap} = addBot(j.reply, j.meta || {});
      if(j.actions && Array.isArray(j.actions) && j.actions.length > 0) {
        const btnRow = elem('div','chips');
        j.actions.forEach(a => {
          const btn = elem('button','chip',a.label);
          btn.onclick = () => handleActionClick(a);
          btnRow.appendChild(btn);
        });
        wrap.appendChild(btnRow);
      }
    }
  })
  .catch(()=>{
    typing(false);
    addBot("I'm having trouble processing that request. Please try again.");
  });
}

async function sendMessage(){
  const text = box.value.trim();
  if(!text) return;
  
  // Disable send button temporarily
  sendBtn.disabled = true;
  
  box.value=''; 
  addUser(text); 
  setProgress(Math.random()*15+10);

  try{
    typing(true);
    const isOnboarding = location.search.includes('mode=onboarding');
    const r = await fetch(API_CHAT,{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+TOKEN},
      body:JSON.stringify({message:text, mode: isOnboarding ? 'onboarding' : ''})
    });
    const j = await r.json(); 
    typing(false);
    
    if(j.redirect) {
      window.location.href = j.redirect;
      return;
    }
    if(j.error){ 
      addBot("⚠️ "+escapeHtml(j.error)); 
      return; 
    }
    if(j.reply) {
      const {bub, wrap} = addBot(j.reply, j.meta || {});
      if(j.actions && Array.isArray(j.actions) && j.actions.length > 0) {
        const btnRow = elem('div','chips');
        j.actions.forEach(a => {
          const btn = elem('button','chip',a.label);
          btn.onclick = () => handleActionClick(a);
          btnRow.appendChild(btn);
        });
        wrap.appendChild(btnRow);
      }
    }
    setProgress(Math.min(100, Math.random()*20+75));
  }catch(e){
    typing(false);
    addBot("I'm experiencing technical difficulties. Please try again in a moment.");
  }finally{
    sendBtn.disabled = false;
  }
}

async function uploadFile(file, docType, chip){
  chip.disabled = true;
  addUser(`Uploading ${file.name} as ${docType}...`);
  
  try{
    const fd = new FormData();
    fd.append('file', file);
    fd.append('doc_type', docType);
    const r = await fetch(API_UPLOAD,{
      method:'POST',
      headers:{'Authorization':'Bearer '+TOKEN},
      body:fd
    });
    const j = await r.json().catch(()=>({}));
    
    if(r.ok && (j.ok!==false)){
      addBot(`✅ Successfully uploaded <b>${escapeHtml(file.name)}</b> as <b>${docType}</b>.`);
      const idx = files.indexOf(file); 
      if(idx>-1){ 
        files.splice(idx,1); 
        refreshAttach(); 
      }
      setProgress(Math.min(100, Math.random()*15+80));
    }else{
      addBot(`⚠️ Upload failed for ${escapeHtml(file.name)}. Please try again later.`);
    }
  }catch(e){
    addBot(`⚠️ Upload error for ${escapeHtml(file.name)}.`);
  }
}

function escapeHtml(s){ 
  return s.replace(/[&<>"']/g,m=>({ 
    '&':'&amp;',
    '<':'&lt;',
    '>':'&gt;',
    '"':'&quot;',
    "'":'&#39;' 
  }[m])); 
}

// Auto-start chat if directly accessed
document.addEventListener('DOMContentLoaded', ()=>{
  if (location.pathname.endsWith('/chat')) {
    widget.classList.remove('hidden'); 
    launch.classList.add('hidden'); 
    start();
  }
});
</script>
</body>
</html>