<!-- === Floating Chatbot Widget (Messenger Style with Timestamps & Poppins) === -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
  :root {
    --primary:#0056D2; --primary-2:#0043a6;
    --bg:#f8f9fa; --white:#fff; --text:#202124; --muted:#6b7280;
    --border:#e8eaed;
  }

  * { font-family: 'Poppins', sans-serif; }

  .launcher {
    position:fixed; right:51px; bottom:51px; width:0px; height:0px;
    border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;
    background:var(--primary); box-shadow:0 8px 25px rgba(0,0,0,.2);
    z-index:1000; transition:all .2s ease;
  }
  .launcher img { width:80px; height:90px; object-fit:contain; }
  .launcher:hover { transform:scale(1.05); }

  .widget {
    position:fixed; right:20px; bottom:20px; width:400px; height:600px;
    background:var(--white); border-radius:14px; box-shadow:0 25px 80px rgba(0,0,0,.2);
    display:flex; flex-direction:column; overflow:hidden; z-index:999; display:none;
  }
  @media(max-width:500px){.widget{width:100vw;height:100vh;right:0;bottom:0;border-radius:0;}}

  .header {
    background:var(--primary); color:#fff; padding:6px 14px;
    display:flex; align-items:center; justify-content:space-between;
  }
  .h-left{display:flex;gap:12px;align-items:center;}
  .avatar img{width:40px;height:48px;}
  .h-title{font-weight:600;font-size:15px;}

  .h-actions{display:flex;gap:10px;}
  .h-actions button{
    background:none;border:none;color:#fff;font-size:18px;cursor:pointer;transition:0.2s;
  }
  .h-actions button:hover{color:#dbeafe;}

  .body{flex:1;background:var(--bg);overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:12px;}

  .msg-wrap{display:flex;align-items:flex-end;gap:8px;max-width:85%;}
  .msg{padding:12px 16px;border-radius:16px;font-size:14px;line-height:1.4;animation:fadeIn .3s ease;word-break:break-word;}
  /* Bot */
  .msg-wrap.bot{align-self:flex-start;flex-direction:row;}
  .msg.bot{background:#ffffff;border:1px solid #e5e7eb;color:#111827;}
  .msg-wrap.bot .ava-s{width:34px;height:34px;border-radius:50%;overflow:hidden;flex-shrink:0;}
  .msg-wrap.bot .ava-s img{width:80%;height:90%;object-fit:cover;}
  /* User */
  .msg-wrap.user{align-self:flex-end;flex-direction:row-reverse;}
  .msg.user{background:var(--primary);color:#fff;border-radius:16px 16px 0 16px;}
  
  /* Timestamp */
  .ts{font-size:11px;color:var(--muted);margin-top:4px;}
  .ts.bot{ text-align:left; margin-left:44px; } /* push right of avatar */
  .ts.user{ text-align:right; margin-right:8px; }

  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px;}
  .chip{padding:6px 12px;border-radius:20px;border:1px solid var(--border);background:#fff;
    font-size:13px;cursor:pointer;transition:all .2s ease;}
  .chip:hover{border-color:var(--primary);color:var(--primary);}

  .foot{background:#fff;padding:8px;border-top:1px solid #ddd;display:flex;gap:6px;align-items:center;}
  .foot textarea{
    flex:1;resize:none;min-height:40px;max-height:100px;
    border:1px solid #ccc;border-radius:20px;padding:0px 14px;
    font-family:Poppins;font-size:12px;outline:none;transition:0.2s;
  }
  .foot textarea:focus{border-color:var(--primary);box-shadow:0 0 0 2px rgba(0,86,210,0.2);}
  .foot button{
    width:42px;height:42px;border-radius:50%;border:none;
    background:var(--primary);color:#fff;font-size:18px;cursor:pointer;
  }
  .foot button:hover{background:var(--primary-2);}
  @keyframes fadeIn{from{opacity:0;transform:translateY(5px);}to{opacity:1;transform:translateY(0);}}

  /* Typing indicator */
  .typing{display:flex;align-items:center;gap:6px;color:var(--muted);font-size:13px;}
  .dot{width:6px;height:6px;border-radius:50%;background:var(--primary);animation:bounce 1.2s infinite;}
  .dot:nth-child(2){animation-delay:.2s;}
  .dot:nth-child(3){animation-delay:.4s;}
  @keyframes bounce{0%,80%,100%{transform:scale(.6);opacity:.5;}40%{transform:scale(1);opacity:1;}}
</style>

<!-- Launcher -->
<div class="launcher" id="launch">
  <img src="https://marketplace.canva.com/_o3Sg/MAGaMB_o3Sg/1/tl/canva-3d-robot-character-reading-a-book-illustration-MAGaMB_o3Sg.png" alt="Bot"/>
</div>

<!-- Chat Widget -->
<div class="widget" id="widget">
  <div class="header">
    <div class="h-left">
      <div class="avatar">
        <img src="https://marketplace.canva.com/_o3Sg/MAGaMB_o3Sg/1/tl/canva-3d-robot-character-reading-a-book-illustration-MAGaMB_o3Sg.png" alt="HR Assistant"/>
      </div>
      <div class="h-title">HR Buddy</div>
    </div>
    <div class="h-actions">
  <button id="refresh" title="Refresh Chat">↻</button>
  <button id="minimize" title="Minimize">–</button>
  <button id="close" title="Close">×</button>
    </div>
  </div>
  <div class="body" id="feed"></div>
  <div class="foot">
    <textarea id="box" placeholder="Type your message here..."></textarea>
    <button id="send" title="Send">➤</button>
  </div>
</div>

<script>

const launch=document.getElementById("launch");
const widget=document.getElementById("widget");
// const closeBtn=document.getElementById("close");
const minimizeBtn=document.getElementById("minimize");
const refreshBtn=document.getElementById("refresh");
const feed=document.getElementById("feed");
const box=document.getElementById("box");
const sendBtn=document.getElementById("send");
const API_URL="/api/chatbot";

let chatStarted = false;

function mdToHtml(text=""){ try{ return marked.parse(text);} catch(e){ return text.replace(/\\n/g,"<br>"); }}

function formatTimestamp(){
  const opts={weekday:"short",month:"short",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:true};
  return new Date().toLocaleString("en-US",opts);
}

function addMsg(text,who="bot",chips=[]){
  const wrap=document.createElement("div");
  wrap.className="msg-wrap "+who;
  if(who==="bot"){
    const ava=document.createElement("div");ava.className="ava-s";
    ava.innerHTML=`<img src="https://marketplace.canva.com/_o3Sg/MAGaMB_o3Sg/1/tl/canva-3d-robot-character-reading-a-book-illustration-MAGaMB_o3Sg.png"/>`;
    wrap.appendChild(ava);
  }
  const msg=document.createElement("div");msg.className="msg "+who;msg.innerHTML=mdToHtml(text.replace(/\n/g, "<br>"));
  wrap.appendChild(msg);feed.appendChild(wrap);

  const ts=document.createElement("div");
  ts.className="ts "+who;
  ts.textContent=formatTimestamp();
  feed.appendChild(ts);

  if(chips.length){
    const c=document.createElement("div");c.className="chips";
    chips.forEach(ch=>{const b=document.createElement("button");b.className="chip";b.textContent=ch;b.onclick=()=>sendMsg(ch,false);c.appendChild(b);});
    feed.appendChild(c);
  }
  feed.scrollTop=feed.scrollHeight;
}

function showTyping(){
  const id="typing";if(document.getElementById(id)) return;
  const wrap=document.createElement("div");wrap.id=id;wrap.className="msg-wrap bot";
  const ava=document.createElement("div");ava.className="ava-s";
  ava.innerHTML=`<img src="https://marketplace.canva.com/_o3Sg/MAGaMB_o3Sg/1/tl/canva-3d-robot-character-reading-a-book-illustration-MAGaMB_o3Sg.png"/>`;
  const msg=document.createElement("div");msg.className="msg bot";
  msg.innerHTML=`<div class="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;
  wrap.appendChild(ava);wrap.appendChild(msg);feed.appendChild(wrap);feed.scrollTop=feed.scrollHeight;
}
function hideTyping(){const el=document.getElementById("typing");if(el)el.remove();}

async function sendMsg(text,showUser=true){
  if(!text)return;if(showUser)addMsg(text,"user");showTyping();
  try{
    // Always ensure user_name and session_id are set
    let userName = localStorage.getItem("user_name") || sessionStorage.getItem("user_name") || "";
    let sessionId = localStorage.getItem("session_id") || sessionStorage.getItem("session_id");
    if(!userName){
      // Prompt for name if not set (optional: replace with your login logic)
      userName = prompt("Please enter your name for a personalized experience:") || "Shilpa";
      localStorage.setItem("user_name", userName);
    }
    if(!sessionId){
      sessionId = 'sess-' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem("session_id", sessionId);
    }
    const profile = { full_name: userName };
    const payload = {message:text, role:"hr", session_id: sessionId, profile: profile};
    const r=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
    const d=await r.json();hideTyping();addMsg(d.message||"","bot",d.quick_replies||[]);
  }catch(e){hideTyping();addMsg("⚠️ Error contacting server.","bot");}
}

sendBtn.onclick=()=>{sendMsg(box.value.trim(),true);box.value="";};
box.addEventListener("keypress",e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendBtn.click();}});

launch.onclick=()=>{
  widget.style.display="flex";
  launch.style.display="none";
  if (!chatStarted) {
    sendMsg("start",false);
    chatStarted = true;
  }
};
const closeBtn = document.getElementById("close");
if (closeBtn) {
  closeBtn.onclick = () => {
    widget.style.display = "none";
    launch.style.display = "flex";
    // Do NOT reset chatStarted or session; just hide the widget
  };
}
minimizeBtn.onclick=()=>{widget.style.display="none";launch.style.display="flex";};
refreshBtn.onclick=()=>{
  feed.innerHTML="";
  sendMsg("start",false);
  chatStarted = true;
};
</script>
